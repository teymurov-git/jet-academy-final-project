{% extends 'base.html' %}
{% load static %}

{% block content %}
  <!-- Start Product -->
  <div class="cs-accent_7_bg_2">
    <div class="cs-height_140 cs-height_lg_80"></div>
    <div class="container">
      <div class="row">
        <div class="col-lg-8">
          <div class="cs-cart_total">
            <h2 class="cs-cart_title cs-semi_bold">My Cart (2 Item)</h2>
          </div>
          <div class="cs-height_30 cs-height_lg_30"></div>
          <div class="cs-table cs-style1  cs-white_bg">
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th class="cs-medium cs-primary_color">Product</th>
                    <th class="cs-medium cs-primary_color">Quantity</th>
                    <th class="cs-medium cs-primary_color text-end">Total</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in basket.items.all %}
                  <tr>
                    <td class="cs-accent_15_border_2">
                      <div class="cs-table_product cs-type1">
                        <div class="cs-product_img"><img src="{{ item.product.cover_image.url }}" alt="Image"></div>
                        <div class="cs-product_right">
                          <a href="#" class="cs-medium cs-primary_color">{{item.product.title}}</a>
                          <div class="cs-product_meta">
                            <span class="cs-table_row_close cs-primary_50_color cs-accent_color_hover cs-transition_3" data-product-id="{{ item.product.id }}">
                                <i class="fas fa-trash-alt"></i>
                            </span>

                            <script>
                            document.querySelectorAll('.cs-table_row_close').forEach(button => {
                                button.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    const productId = this.dataset.productId;

                                    fetch('/update_item/', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'X-CSRFToken': getCookie('csrftoken'),
                                        },
                                        body: JSON.stringify({ 'productId': productId, 'action': 'remove' })
                                    })
                                    .then(response => response.json())
                                    .then(data => {
                                        console.log('Success:', data);
                                        // İstəsən row-u silmək üçün:
                                        this.closest('tr').remove(); // Əgər table row içindəsə
                                    })
                                    .catch((error) => {
                                        console.error('Error:', error);
                                    });
                                });
                            });

                            // Django üçün CSRF token funksiyası
                            function getCookie(name) {
                                let cookieValue = null;
                                if (document.cookie && document.cookie !== '') {
                                    const cookies = document.cookie.split(';');
                                    for (let i = 0; i < cookies.length; i++) {
                                        const cookie = cookies[i].trim();
                                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                            break;
                                        }
                                    }
                                }
                                return cookieValue;
                            }
                            </script>
                            <a href="#" class="cs-move_wish cs-primary_50_color">Move to wish list <i class="far fa-heart"></i></a>
                          </div>
                        </div>
                      </div>
                    </td>
                    <td class="cs-accent_15_border_2">
                      <div class="cs-quantity cs-style1 cs-accent_40_border_2">
                        <button class="cs-quantity_btn cs-center cs-accent_color_2 cs-accent_10_bg_2 cs-white_hover cs-accent_bg_2_hover"><i class="fas fa-minus"></i></button>
                        <input type="text" value="{{item.quantity}}" class="cs-quantity_number">
                        <button class="cs-quantity_btn cs-center cs-accent_color_2 cs-accent_10_bg_2 cs-white_hover cs-accent_bg_2_hover"><i class="fas fa-plus"></i></button>
                      </div>
                    </td>
                    <td class="cs-accent_15_border_2 text-end">
                      ${{item.price}}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <div class="cs-update_cart cs-accent_15_border_2">
              <div class="cs-update_left">
                <form class="cs-coupon">
                </form>
              </div>
              <div class="cs-update_right">
              </div>
            </div>
          </div>
          <div class="cs-height_30 cs-height_lg_30"></div>
        </div>
        <div class="col-lg-4">
          <div class="cs-summary">
            <h3 class="cs-summary_title">Checkout Summary</h3>
            <ul class="cs-summary_list cs-mp0">
              <li class="cs-accent_15_border_2">
                <span>Total</span>
                <span>${{basket.total_price}}</span>
              </li>
              <li class="cs-accent_15_border_2">
              </li>
            </ul>
            <div class="text-center">
              <a href="{% url 'checkout' %}" class="cs-btn cs-style1 cs-rounded cs-medium cs-primary_font cs-accent_bg cs-accent_border cs-white cs-accent_bg_2_hover cs-white_hover cs-accent_border_2_hover">Procced to Checkout</a>
            </div>
          </div>
          <div class="cs-height_30 cs-height_lg_30"></div>
        </div>
      </div>
    </div>
    <div class="cs-height_110 cs-height_lg_50"></div>
  </div>
  <!-- End Product -->
{% endblock %}
  

{% block sellof %}

{% endblock %}

{% block js %}
  <!-- Script -->
  <script src="{% static '../static/js/plugins/jquery-3.6.0.min.js' %}"></script>
  <script src="{% static '../static/js/plugins/isotope.pkg.min.js' %}"></script>
  <script src="{% static '../static/js/plugins/jquery.slick.min.js' %}"></script>
  <script src="{% static '../static/js/plugins/lightgallery.min.js' %}"></script>
  <script src="{% static '../static/js/plugins/jquery.counter.min.js' %}"></script>
  <script src="{% static '../static/js/plugins/jquery-ui.js' %}"></script>
  <script src="{% static '../static/js/plugins/select2.min.js' %}"></script>
  <script src="{% static '../static/js/plugins/wow.min.js' %}"></script>
  <script src="{% static '../static/js/main.js' %}"></script>
{% endblock %}